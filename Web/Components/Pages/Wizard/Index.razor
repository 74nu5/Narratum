@page "/wizard"
@rendermode InteractiveServer
@using Narratum.Web.Components.Shared
@using static Narratum.Web.Components.Shared.CharactersEditor
@using static Narratum.Web.Components.Shared.LocationsEditor
@inject NavigationManager Navigation
@inject GenerationService GenService

<PageTitle>Cr√©er une histoire - Narratum</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24">
    <FluentLabel Typo="Typography.H2">‚ú® Cr√©er une nouvelle histoire</FluentLabel>
    
    @* Step indicator *@
    <FluentCard>
        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
            @for (int i = 0; i < _stepTitles.Length; i++)
            {
                var stepIndex = i;
                <FluentButton Appearance="@(stepIndex == _currentStep ? Appearance.Accent : Appearance.Neutral)"
                              Disabled="@(stepIndex > _currentStep)"
                              @onclick="() => _currentStep = stepIndex">
                    @(stepIndex + 1). @_stepTitles[stepIndex]
                </FluentButton>
            }
        </FluentStack>
    </FluentCard>
    
    @* Step content *@
    <div>
        @switch (_currentStep)
        {
            case 0: @* Monde *@
                <WorldEditor @bind-WorldName="_worldName" @bind-WorldDescription="_worldDescription" />
                break;
                
            case 1: @* Genre *@
                <FluentCard>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                        <FluentSelect TOption="string" Label="Genre" @bind-Value="_genre">
                            <FluentOption TOption="string" Value="Fantasy">Fantasy</FluentOption>
                            <FluentOption TOption="string" Value="SciFi">Science-Fiction</FluentOption>
                            <FluentOption TOption="string" Value="Mystery">Myst√®re</FluentOption>
                            <FluentOption TOption="string" Value="Horror">Horreur</FluentOption>
                            <FluentOption TOption="string" Value="Historical">Historique</FluentOption>
                        </FluentSelect>
                        <FluentTextArea Label="Style narratif (optionnel)" @bind-Value="_narrativeStyle" Rows="3" 
                                      Placeholder="Ex: √âpique, sombre, humoristique..." />
                    </FluentStack>
                </FluentCard>
                break;
                
            case 2: @* Personnages *@
                <CharactersEditor @bind-Characters="_characters" />
                break;
                
            case 3: @* Lieux *@
                <LocationsEditor @bind-Locations="_locations" />
                break;
                
            case 4: @* R√©sum√© *@
                <FluentCard>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                        <FluentLabel Typo="Typography.H4">üìã R√©capitulatif</FluentLabel>
                        <FluentLabel><strong>Monde :</strong> @_worldName</FluentLabel>
                        <FluentLabel><strong>Description :</strong> @(_worldDescription ?? "Aucune")</FluentLabel>
                        <FluentLabel><strong>Genre :</strong> @_genre</FluentLabel>
                        <FluentLabel><strong>Style :</strong> @(_narrativeStyle ?? "Par d√©faut")</FluentLabel>
                        <FluentLabel><strong>Personnages :</strong> @_characters.Count</FluentLabel>
                        <FluentLabel><strong>Lieux :</strong> @_locations.Count</FluentLabel>
                        
                        @if (_characters.Count > 0)
                        {
                            <FluentLabel Typo="Typography.Body"><strong>Liste des personnages :</strong></FluentLabel>
                            <ul>
                                @foreach (var c in _characters)
                                {
                                    <li>@c.Name @(string.IsNullOrEmpty(c.Description) ? "" : $"- {c.Description}")</li>
                                }
                            </ul>
                        }
                    </FluentStack>
                </FluentCard>
                break;
        }
    </div>
    
    @* Navigation buttons *@
    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="12" HorizontalAlignment="HorizontalAlignment.End">
        <FluentButton Appearance="Appearance.Neutral" Href="/">Annuler</FluentButton>
        
        @if (_currentStep > 0)
        {
            <FluentButton Appearance="Appearance.Neutral" @onclick="PreviousStep">‚Üê Pr√©c√©dent</FluentButton>
        }
        
        @if (_currentStep < _stepTitles.Length - 1)
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="NextStep" Disabled="@(!CanProceed)">
                Suivant ‚Üí
            </FluentButton>
        }
        else
        {
            <FluentButton Appearance="Appearance.Accent" @onclick="CreateStory" Disabled="@(!CanCreate)">
                üöÄ Cr√©er l'histoire
            </FluentButton>
        }
    </FluentStack>
</FluentStack>

@code {
    private readonly string[] _stepTitles = { "Monde", "Genre", "Personnages", "Lieux", "R√©sum√©" };
    private int _currentStep = 0;
    
    private string _worldName = string.Empty;
    private string _worldDescription = string.Empty;
    private string _genre = "Fantasy";
    private string _narrativeStyle = string.Empty;
    private List<CharacterInput> _characters = new();
    private List<LocationInput> _locations = new();
    
    private bool CanProceed => _currentStep switch
    {
        0 => !string.IsNullOrWhiteSpace(_worldName),
        2 => _characters.Count > 0,
        _ => true
    };
    
    private bool CanCreate => !string.IsNullOrWhiteSpace(_worldName) && _characters.Count > 0;
    
    private void NextStep()
    {
        if (_currentStep < _stepTitles.Length - 1)
            _currentStep++;
    }
    
    private void PreviousStep()
    {
        if (_currentStep > 0)
            _currentStep--;
    }
    
    private async Task CreateStory()
    {
        var slotName = $"story-{DateTime.UtcNow:yyyyMMdd-HHmmss}";
        
        // Create story via service
        await GenService.CreateStoryAsync(
            slotName,
            _worldName,
            _genre,
            _characters.Select(c => c.Name).ToList());
        
        Navigation.NavigateTo($"/generation/{slotName}");
    }
}

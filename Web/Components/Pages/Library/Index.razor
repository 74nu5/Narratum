@page "/library"
@rendermode InteractiveServer
@inject StoryLibraryService LibraryService
@inject NavigationManager Navigation

<PageTitle>Biblioth√®que - Narratum</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24">
    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
        <FluentLabel Typo="Typography.H2">üìö Biblioth√®que</FluentLabel>
        <FluentButton Appearance="Appearance.Accent" Href="/wizard">
            ‚ûï Nouvelle histoire
        </FluentButton>
    </FluentStack>

    @if (_stories == null)
    {
        <FluentProgressRing />
    }
    else if (!_stories.Any())
    {
        <FluentCard>
            <FluentStack Orientation="Orientation.Vertical" VerticalAlignment="VerticalAlignment.Center" Style="min-height: 200px;">
                <FluentLabel Typo="Typography.H4">Aucune histoire</FluentLabel>
                <FluentLabel>Cr√©ez votre premi√®re histoire pour commencer !</FluentLabel>
                <FluentButton Appearance="Appearance.Accent" Href="/wizard" Style="margin-top: 16px;">
                    ‚ú® Cr√©er une histoire
                </FluentButton>
            </FluentStack>
        </FluentCard>
    }
    else
    {
        <FluentDataGrid Items="@_stories.AsQueryable()" GridTemplateColumns="2fr 1fr 1fr 1fr 250px" Style="width: 100%;">
            <PropertyColumn Property="@(s => s.DisplayName ?? s.SlotName)" Title="Titre" Sortable="true" />
            <PropertyColumn Property="@(s => s.GenreStyle)" Title="Genre" Sortable="true" />
            <PropertyColumn Property="@(s => s.PageCount)" Title="Pages" Sortable="true" />
            <PropertyColumn Property="@(s => s.LastModified)" Title="Modifi√©e" Format="g" Sortable="true" />
            <TemplateColumn Title="Actions">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                    <FluentButton Appearance="Appearance.Accent" @onclick="() => ContinueStory(context.SlotName)">
                        ‚ñ∂Ô∏è Continuer
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Neutral" @onclick="() => ReadStory(context.SlotName)">
                        üìñ Lire
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Stealth" @onclick="() => DeleteStory(context.SlotName)">
                        üóëÔ∏è
                    </FluentButton>
                </FluentStack>
            </TemplateColumn>
        </FluentDataGrid>
    }
</FluentStack>

@code {
    private List<StoryEntry>? _stories;

    protected override async Task OnInitializedAsync()
    {
        _stories = await LibraryService.ListStoriesAsync();
    }

    private void ContinueStory(string slotName)
    {
        Navigation.NavigateTo($"/generation/{slotName}");
    }

    private void ReadStory(string slotName)
    {
        Navigation.NavigateTo($"/reader/{slotName}");
    }

    private async Task DeleteStory(string slotName)
    {
        await LibraryService.DeleteStoryAsync(slotName);
        _stories = await LibraryService.ListStoriesAsync();
    }
}

